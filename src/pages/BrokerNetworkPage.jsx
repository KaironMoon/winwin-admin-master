import React, { useState, useEffect, useCallback } from 'react';
import { DollarSign, TrendingUp, Users, X, Save, History, ChevronRight, ChevronDown, Calendar, Loader2, RefreshCw, AlertCircle } from 'lucide-react';
import config from '../config';

const BrokerNetworkPage = () => {
  const [selectedBroker, setSelectedBroker] = useState(null);
  const [showRateModal, setShowRateModal] = useState(false);
  const [newRate, setNewRate] = useState('');
  const [selectedYear, setSelectedYear] = useState('2024');
  const [selectedMonth, setSelectedMonth] = useState('03');
  const [hierarchyData, setHierarchyData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  // const [userInfo, setUserInfo] = useState(null);
  const [maxDepth] = useState(5); // ÏµúÎåÄ ÍπäÏù¥ ÏÑ§Ï†ï

  // ÎÖÑÎèÑ Î∞è Ïõî ÏòµÏÖò
  const years = ['2024', '2023', '2022'];
  const months = [
    { value: '01', label: '1Ïõî' },
    { value: '02', label: '2Ïõî' },
    { value: '03', label: '3Ïõî' },
    { value: '04', label: '4Ïõî' },
    { value: '05', label: '5Ïõî' },
    { value: '06', label: '6Ïõî' },
    { value: '07', label: '7Ïõî' },
    { value: '08', label: '8Ïõî' },
    { value: '09', label: '9Ïõî' },
    { value: '10', label: '10Ïõî' },
    { value: '11', label: '11Ïõî' },
    { value: '12', label: '12Ïõî' }
  ];

  // API Ìò∏Ï∂ú Ìï®Ïàò: Í≥ÑÏ∏µ Ìä∏Î¶¨ Í∞ÄÏ†∏Ïò§Í∏∞
  const fetchHierarchyTree = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      // localStorageÏóêÏÑú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ÏôÄ ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
      const tokenDataStr = localStorage.getItem('tokenData');
      const userInfoStr = localStorage.getItem('userInfo');

      let token = null;
      try {
        if (tokenDataStr) {
          const tokenData = JSON.parse(tokenDataStr);
          token = tokenData.token;
        }
      } catch (error) {
        console.error('Error parsing tokenData:', error);
      }

      console.log('üîç Token exists:', !!token);
      console.log('üîç UserInfo:', userInfoStr);

      if (!token || !userInfoStr) {
        throw new Error('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
      }

      const currentUser = JSON.parse(userInfoStr);
      // setUserInfo(currentUser); // Commented out - userInfo not used
      console.log('üë§ Current User:', currentUser.name, currentUser.email);

      // API ÏóîÎìúÌè¨Ïù∏Ìä∏ ÏÑ§Ï†ï
      const endpoint = `${config.API_BASE_URL}/api/hierarchy/my-tree?max_depth=${maxDepth}`;
      console.log('üåê API Endpoint:', endpoint);

      // Í≥ÑÏ∏µ Ìä∏Î¶¨ API Ìò∏Ï∂ú
      const response = await fetch(endpoint, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      console.log('üì° Response Status:', response.status);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Error Response:', errorText);
        if (response.status === 401) {
          throw new Error('Ïù∏Ï¶ùÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
        }
        throw new Error(`Í≥ÑÏ∏µ Ìä∏Î¶¨Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. (${response.status})`);
      }

      const data = await response.json();
      console.log('‚úÖ Hierarchy Tree Data:', data);
      setHierarchyData(data);

    } catch (err) {
      console.error('‚ùå Error fetching hierarchy tree:', err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, [maxDepth]);

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú API Ìò∏Ï∂ú
  useEffect(() => {
    fetchHierarchyTree();
  }, [fetchHierarchyTree]);

  // ÏÉÅÎã® Ïç®Î®∏Î¶¨ Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î°ú Í≥ÑÏÇ∞)
  const calculateSummary = () => {
    if (!hierarchyData) {
      return {
        incomingSettlement: '‚Ç©0',
        outgoingSettlement: '‚Ç©0',
        netProfit: '‚Ç©0'
      };
    }

    // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Í≥ÑÏÇ∞ (statsÏóêÏÑú Í∞ÄÏ†∏Ïò¥)
    const totalRevenue = hierarchyData.stats?.total_revenue || 0;
    const directRevenue = totalRevenue * 0.7; // Î∞õÏùÑ Ï†ïÏÇ∞Í∏à (ÏòàÏãú)
    const payoutRevenue = totalRevenue * 0.5; // ÏßÄÍ∏âÌï† Ï†ïÏÇ∞Í∏à (ÏòàÏãú)
    const netProfit = directRevenue - payoutRevenue;

    return {
      incomingSettlement: `‚Ç©${directRevenue.toLocaleString()}`,
      outgoingSettlement: `‚Ç©${payoutRevenue.toLocaleString()}`,
      netProfit: `‚Ç©${netProfit.toLocaleString()}`
    };
  };

  const summary = calculateSummary();

  // 35Í±¥Ïóê ÎßûÎäî Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ìï®Ïàò
  /*
  const generateOrderDetails = (count) => {
    const symbols = ['BTC-USDT-SWAP', 'ETH-USDT-SWAP', 'SOL-USDT-SWAP', 'DOGE-USDT-SWAP', 'ADA-USDT-SWAP', 'XRP-USDT-SWAP', 'BNB-USDT-SWAP', 'MATIC-USDT-SWAP', 'LTC-USDT-SWAP', 'LINK-USDT-SWAP', 'DOT-USDT-SWAP', 'AVAX-USDT-SWAP', 'UNI-USDT-SWAP', 'ATOM-USDT-SWAP', 'FTM-USDT-SWAP'];
    const sides = ['long', 'short'];
    const leverages = ['10x', '15x', '20x', '25x', '30x'];
    
    const orders = [];
    for (let i = 0; i < count; i++) {
      const isProfit = Math.random() > 0.3; // 70% ÌôïÎ•†Î°ú ÏàòÏùµ
      const symbol = symbols[Math.floor(Math.random() * symbols.length)];
      const side = sides[Math.floor(Math.random() * sides.length)];
      const size = (Math.random() * 100).toFixed(2);
      const leverage = leverages[Math.floor(Math.random() * leverages.length)];
      const pnl = isProfit 
        ? `+‚Ç©${(Math.random() * 50000 + 1000).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`
        : `-‚Ç©${(Math.random() * 10000 + 500).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
      
      const day = Math.floor(Math.random() * 28) + 1;
      const hour = Math.floor(Math.random() * 24);
      const minute = Math.floor(Math.random() * 60);
      const date = `2024-03-${day.toString().padStart(2, '0')} ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
      
      orders.push({
        id: i + 1,
        date,
        symbol,
        side,
        size,
        leverage,
        pnl
      });
    }
    return orders.sort((a, b) => new Date(b.date) - new Date(a.date));
  };
  */

  // Î∏åÎ°úÏª§ ÎÑ§Ìä∏ÏõåÌÅ¨ Îç∞Ïù¥ÌÑ∞ (5ÎéÅÏä§ Íµ¨Ï°∞) - Commented out to fix lint warnings
  /* const networkData = {
    me: {
      id: 'me',
      name: 'ÎÇò (Ï¥ù Î∏åÎ°úÏª§)',
      rate: '0.02%',
      revenue: '‚Ç©15,080,000'
    },
    brokers: [
      {
        id: 'broker1',
        name: 'ÍπÄÎåÄÎ¶¨',
        rate: '0.015%',
        revenue: '‚Ç©3,450,000',
        totalOrders: 1265,
        level: 1,
        subBrokers: [
          {
            id: 'sub1_1',
            name: 'ÏÑúÏ∞®Ïû•',
            rate: '0.012%',
            revenue: '‚Ç©1,200,000',
            totalOrders: 456,
            level: 2,
            subBrokers: [
              {
                id: 'sub1_1_1',
                name: 'ÌôçÌåÄÏû•',
                rate: '0.009%',
                revenue: '‚Ç©580,000',
                totalOrders: 234,
                level: 3,
                subBrokers: [
                  {
                    id: 'sub1_1_1_1',
                    name: 'ÍπÄÏÇ¨Ïõê',
                    rate: '0.006%',
                    revenue: '‚Ç©250,000',
                    totalOrders: 95,
                    level: 4,
                    members: [
                      { 
                        id: 'member1_1_1_1_1', 
                        name: 'Í≥†Í∞ùA', 
                        revenue: '‚Ç©80,000', 
                        orders: 35,
                        orderDetails: generateOrderDetails(35)
                      },
                      { 
                        id: 'member1_1_1_1_2', 
                        name: 'Í≥†Í∞ùB', 
                        revenue: '‚Ç©65,000', 
                        orders: 28,
                        orderDetails: generateOrderDetails(28)
                      },
                      { 
                        id: 'member1_1_1_1_3', 
                        name: 'Í≥†Í∞ùC', 
                        revenue: '‚Ç©75,000', 
                        orders: 32,
                        orderDetails: generateOrderDetails(32)
                      }
                    ]
                  }
                ],
                members: [
                  { 
                    id: 'member1_2_1_1', 
                    name: 'ÏÜ°Í≥†Í∞ù', 
                    revenue: '‚Ç©90,000', 
                    orders: 42,
                    orderDetails: generateOrderDetails(42)
                  },
                  { 
                    id: 'member1_2_1_2', 
                    name: 'ÌïúÍ≥†Í∞ù', 
                    revenue: '‚Ç©85,000', 
                    orders: 39,
                    orderDetails: generateOrderDetails(39)
                  },
                  { 
                    id: 'member1_2_1_3', 
                    name: 'ÏûÑÍ≥†Í∞ù', 
                    revenue: '‚Ç©95,000', 
                    orders: 44,
                    orderDetails: generateOrderDetails(44)
                  },
                  { 
                    id: 'member1_2_1_4', 
                    name: 'Î∞∞Í≥†Í∞ù', 
                    revenue: '‚Ç©80,000', 
                    orders: 36,
                    orderDetails: generateOrderDetails(36)
                  }
                ]
              }
            ]
          }
        ],
        members: [
          { id: 'member1_1', name: 'Ïù¥Í≥†Í∞ù', revenue: '‚Ç©120,000', orders: 55, orderDetails: generateOrderDetails(55) },
          { id: 'member1_2', name: 'Î∞ïÍ≥†Í∞ù', revenue: '‚Ç©95,000', orders: 42, orderDetails: generateOrderDetails(42) },
          { id: 'member1_3', name: 'ÏµúÍ≥†Í∞ù', revenue: '‚Ç©110,000', orders: 48, orderDetails: generateOrderDetails(48) }
        ]
      },
      {
        id: 'broker2',
        name: 'Î∞ïÍ≥ºÏû•',
        rate: '0.018%',
        revenue: '‚Ç©2,890,000',
        totalOrders: 987,
        level: 1,
        members: [
          { id: 'member2_1', name: 'Ï†ïÍ≥†Í∞ù', revenue: '‚Ç©140,000', orders: 62, orderDetails: generateOrderDetails(62) },
          { id: 'member2_2', name: 'Í∞ïÍ≥†Í∞ù', revenue: '‚Ç©125,000', orders: 58, orderDetails: generateOrderDetails(58) },
          { id: 'member2_3', name: 'Ï°∞Í≥†Í∞ù', revenue: '‚Ç©135,000', orders: 61, orderDetails: generateOrderDetails(61) }
        ]
      }
    ]
  }; */

  // Î∏åÎ°úÏª§ ÏÑ†ÌÉù Ìï∏Îì§Îü¨ - Commented out to fix lint warnings
  /* const handleBrokerClick = (broker) => {
    setSelectedBroker(broker);
    setNewRate(broker.rate);
    setShowRateModal(true);
  }; */

  // Î©§Î≤Ñ Ï£ºÎ¨∏ ÏÉÅÏÑ∏ ÌÜ†Í∏Ä - Commented out to fix lint warnings
  /* const toggleMemberOrders = (memberId) => {
    const newExpanded = new Set(expandedMembers);
    if (newExpanded.has(memberId)) {
      newExpanded.delete(memberId);
    } else {
      newExpanded.add(memberId);
    }
    setExpandedMembers(newExpanded);
  }; */

  // Î†àÎ≤®Î≥Ñ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï - Commented out to fix lint warnings
  /* const getLevelStyle = (level) => {
    const styles = {
      1: { color: 'from-purple-500 to-purple-700', size: 'w-8 h-8', textSize: 'text-sm' },
      2: { color: 'from-indigo-500 to-indigo-700', size: 'w-7 h-7', textSize: 'text-sm' },
      3: { color: 'from-violet-500 to-violet-700', size: 'w-6 h-6', textSize: 'text-xs' },
      4: { color: 'from-pink-500 to-pink-700', size: 'w-6 h-6', textSize: 'text-xs' },
      5: { color: 'from-rose-500 to-rose-700', size: 'w-5 h-5', textSize: 'text-xs' }
    };
    return styles[level] || styles[5];
  }; */

  // Ìä∏Î¶¨ ÎÜíÏù¥ Í≥ÑÏÇ∞ Ìï®Ïàò - Commented out to fix lint warnings
  /* const calculateTreeHeight = (broker) => {
    let height = 60; // Í∏∞Î≥∏ Î∏åÎ°úÏª§ ÎÜíÏù¥

    if (broker.members && broker.members.length > 0) {
      broker.members.forEach(member => {
        height += 60; // Î©§Î≤Ñ Í∏∞Î≥∏ ÎÜíÏù¥
        if (expandedMembers.has(member.id) && member.orderDetails) {
          height += member.orderDetails.length * 35; // Ï£ºÎ¨∏Îãπ 35px
        }
      });
    }

    if (broker.subBrokers && broker.subBrokers.length > 0) {
      broker.subBrokers.forEach(subBroker => {
        height += calculateTreeHeight(subBroker) + 20;
      });
    }

    return height;
  }; */

  // Ï†ïÏÇ∞ ÏöîÏú® ÏóÖÎç∞Ïù¥Ìä∏
  const handleRateUpdate = () => {
    console.log(`${selectedBroker.name}Ïùò ÏöîÏú®ÏùÑ ${newRate}Î°ú Î≥ÄÍ≤Ω`);
    setShowRateModal(false);
    setSelectedBroker(null);
  };

  // Í∞êÏÇ¨ Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞
  const auditLogs = [
    { id: 1, broker: 'ÍπÄÎåÄÎ¶¨', oldRate: '0.010%', newRate: '0.015%', changedBy: 'Í¥ÄÎ¶¨Ïûê', date: '2024-03-20 14:30' },
    { id: 2, broker: 'ÏÑúÏ∞®Ïû•', oldRate: '0.008%', newRate: '0.012%', changedBy: 'ÍπÄÎåÄÎ¶¨', date: '2024-03-19 09:15' },
    { id: 3, broker: 'ÌôçÌåÄÏû•', oldRate: '0.006%', newRate: '0.009%', changedBy: 'ÏÑúÏ∞®Ïû•', date: '2024-03-18 16:45' },
    { id: 4, broker: 'ÍπÄÏÇ¨Ïõê', oldRate: '0.004%', newRate: '0.006%', changedBy: 'ÌôçÌåÄÏû•', date: '2024-03-17 11:20' },
    { id: 5, broker: 'Î∞ïÍ≥ºÏû•', oldRate: '0.015%', newRate: '0.018%', changedBy: 'Í¥ÄÎ¶¨Ïûê', date: '2024-03-16 13:50' }
  ];

  // Ïû¨Í∑ÄÏ†Å ÎÖ∏Îìú Î†åÎçîÎßÅ Ïª¥Ìè¨ÎÑåÌä∏ - Î™®Îçò ÎîîÏûêÏù∏
  const HierarchyNode = ({ node, level = 1, isLast = false, parentRef = null }) => {
    const nodeRef = React.useRef(null);
    const [isExpanded, setIsExpanded] = useState(true);

    // React HookÏùÄ Ï°∞Í±¥Î∂Ä return Ï†ÑÏóê Ìò∏Ï∂úÎêòÏñ¥Ïïº Ìï®
    React.useEffect(() => {
      // Î∂ÄÎ™®ÏôÄ ÌòÑÏû¨ ÎÖ∏Îìú Ïó∞Í≤∞ÏÑ† Í∑∏Î¶¨Í∏∞
      if (parentRef && nodeRef.current && level > 1) {
        // const parent = parentRef.current; // Commented out - unused
        // const current = nodeRef.current; // Commented out - unused
        // const parentRect = parent.getBoundingClientRect(); // Commented out - unused
        // const currentRect = current.getBoundingClientRect(); // Commented out - unused

        // Ïó¨Í∏∞ÏÑú Ïó∞Í≤∞ÏÑ†ÏùÑ Í∑∏Î¶¥ Ïàò ÏûàÏßÄÎßå, CSSÎ°ú Ï≤òÎ¶¨ÌïòÎäî Í≤ÉÏù¥ Îçî Í∞ÑÎã®
      }
    }, [parentRef, level]);

    if (!node) return null;

    const hasChildren = node.children && node.children.length > 0;

    // Î†àÎ≤®Î≥Ñ ÏÉâÏÉÅ Î∞è Ïä§ÌÉÄÏùº - Îçî ÏÑ∏Î†®Îêú ÏÉâÏÉÅ
    const getLevelColor = () => {
      switch(level) {
        case 1: return {
          gradient: 'from-purple-600 to-indigo-600',
          border: 'border-purple-500/30',
          bg: 'bg-purple-500/10',
          icon: 'bg-gradient-to-br from-purple-500 to-purple-700',
          label: 'bg-purple-500',
          text: 'text-purple-300'
        };
        case 2: return {
          gradient: 'from-blue-600 to-cyan-600',
          border: 'border-blue-500/30',
          bg: 'bg-blue-500/10',
          icon: 'bg-gradient-to-br from-blue-500 to-blue-700',
          label: 'bg-blue-500',
          text: 'text-blue-300'
        };
        case 3: return {
          gradient: 'from-violet-600 to-purple-600',
          border: 'border-violet-500/30',
          bg: 'bg-violet-500/10',
          icon: 'bg-gradient-to-br from-violet-500 to-violet-700',
          label: 'bg-violet-500',
          text: 'text-violet-300'
        };
        case 4: return {
          gradient: 'from-pink-600 to-rose-600',
          border: 'border-pink-500/30',
          bg: 'bg-pink-500/10',
          icon: 'bg-gradient-to-br from-pink-500 to-pink-700',
          label: 'bg-pink-500',
          text: 'text-pink-300'
        };
        default: return {
          gradient: 'from-emerald-600 to-green-600',
          border: 'border-emerald-500/30',
          bg: 'bg-emerald-500/10',
          icon: 'bg-gradient-to-br from-emerald-500 to-emerald-700',
          label: 'bg-emerald-500',
          text: 'text-emerald-300'
        };
      }
    };

    const levelStyle = getLevelColor();

    // Î™®Ïùò ÏàòÏùµ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Í≤ΩÏö∞)
    const getRevenueData = () => {
      if (node.stats?.total_revenue) {
        return `‚Ç©${node.stats.total_revenue.toLocaleString()}`;
      }
      // Î†àÎ≤®Î≥Ñ Í∏∞Î≥∏ ÏàòÏùµ
      const revenues = {
        1: Math.floor(Math.random() * 5000000) + 3000000,
        2: Math.floor(Math.random() * 2000000) + 1000000,
        3: Math.floor(Math.random() * 1000000) + 500000,
        4: Math.floor(Math.random() * 500000) + 200000,
        5: Math.floor(Math.random() * 200000) + 50000
      };
      return `‚Ç©${(revenues[level] || 80000).toLocaleString()}`;
    };

    // Î™®Ïùò ÏöîÏú® Îç∞Ïù¥ÌÑ∞
    const getRateData = () => {
      const rates = {
        1: '0.015%',
        2: '0.012%',
        3: '0.008%',
        4: '0.006%',
        5: null
      };
      return rates[level];
    };

    const revenue = getRevenueData();
    const rate = getRateData();

    return (
      <div className="relative" style={{ marginLeft: level > 1 ? '48px' : 0 }}>
        {/* Ïó∞Í≤∞ÏÑ† (Î†àÎ≤® 2 Ïù¥ÏÉÅ) - Îçî ÏÑ∏Î†®Îêú Ïä§ÌÉÄÏùº */}
        {level > 1 && (
          <>
            {/* Í≥°ÏÑ† Ïó∞Í≤∞ÏÑ† */}
            <div
              className="absolute"
              style={{
                left: '-24px',
                top: '28px',
                width: '24px',
                height: '2px',
                background: 'linear-gradient(90deg, rgba(156, 163, 175, 0.3) 0%, rgba(156, 163, 175, 0.5) 100%)'
              }}
            />
            {/* ÏàòÏßÅÏÑ† (ÎßàÏßÄÎßâ ÎÖ∏ÎìúÍ∞Ä ÏïÑÎãê Îïå) */}
            {!isLast && (
              <div
                className="absolute"
                style={{
                  left: '-24px',
                  top: '28px',
                  width: '2px',
                  height: '96px',
                  background: 'linear-gradient(180deg, rgba(156, 163, 175, 0.5) 0%, rgba(156, 163, 175, 0.3) 100%)'
                }}
              />
            )}
          </>
        )}

        {/* ÎÖ∏Îìú Ïπ¥Îìú - Î™®Îçò Í∏ÄÎûòÏä§Î™®ÌîºÏ¶ò ÎîîÏûêÏù∏ */}
        <div ref={nodeRef} className="mb-4 group">
          <div
            className={`
              relative overflow-hidden
              ${levelStyle.bg} ${levelStyle.border}
              backdrop-blur-xl bg-opacity-50
              border rounded-2xl
              p-4 pr-6
              hover:shadow-2xl hover:scale-[1.02]
              transition-all duration-300 ease-out
              cursor-pointer
            `}
            onClick={() => hasChildren && setIsExpanded(!isExpanded)}
          >
            {/* Î∞∞Í≤Ω Í∑∏ÎùºÎç∞Ïù¥ÏÖò Ìö®Í≥º */}
            <div className={`absolute inset-0 bg-gradient-to-r ${levelStyle.gradient} opacity-5`} />

            <div className="relative flex items-center gap-4">
              {/* ÏïÑÎ∞îÌÉÄ */}
              <div className="relative flex-shrink-0">
                <div className={`
                  w-12 h-12 ${levelStyle.icon}
                  rounded-xl shadow-lg
                  flex items-center justify-center
                  text-white font-bold text-lg
                  group-hover:shadow-xl group-hover:scale-110
                  transition-all duration-300
                `}>
                  {node.user?.name?.charAt(0) || '?'}
                </div>
                {/* ÏßÅÏ†ë Ï∂îÏ≤ú Ïàò Î∞∞ÏßÄ */}
                {node.user?.direct_referral_count > 0 && (
                  <div className="absolute -top-2 -right-2 min-w-[24px] h-6 px-1.5
                                bg-gradient-to-r from-orange-500 to-red-500
                                rounded-full flex items-center justify-center
                                text-xs text-white font-bold shadow-lg
                                group-hover:scale-110 transition-transform">
                    {node.user.direct_referral_count}
                  </div>
                )}
              </div>

              {/* Ï†ïÎ≥¥ ÏÑπÏÖò */}
              <div className="flex-1 min-w-0">
                {/* Ïù¥Î¶ÑÍ≥º Î†àÎ≤® */}
                <div className="flex items-center gap-3 mb-2">
                  <h3 className="font-bold text-white text-base">
                    {node.user?.name || 'ÏùµÎ™Ö'}
                  </h3>
                  <span className={`
                    px-2.5 py-1 ${levelStyle.label}
                    text-white text-xs font-bold rounded-lg
                    shadow-md
                  `}>
                    L{level}
                  </span>
                </div>

                {/* ÌÜµÍ≥Ñ Ï†ïÎ≥¥ - ÏïÑÏù¥ÏΩò Ï∂îÍ∞Ä */}
                <div className="flex flex-wrap items-center gap-4">
                  {rate && (
                    <div className="flex items-center gap-1.5">
                      <div className="w-1.5 h-1.5 bg-yellow-400 rounded-full animate-pulse" />
                      <span className="text-yellow-400 text-sm font-medium">
                        {rate}
                      </span>
                    </div>
                  )}
                  <div className="flex items-center gap-1.5">
                    <div className="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse" />
                    <span className="text-green-400 text-sm font-medium">
                      {revenue}
                    </span>
                  </div>
                  <div className="flex items-center gap-1.5">
                    <div className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse" />
                    <span className="text-blue-400 text-sm font-medium">
                      {node.stats?.total_referrals || 0}Î™Ö
                    </span>
                  </div>
                </div>

                {/* Ïù¥Î©îÏùº (ÏÑ†ÌÉùÏ†Å) */}
                <div className="mt-2 text-xs text-gray-500">
                  {node.user?.email}
                </div>
              </div>

              {/* ÌôïÏû•/Ï∂ïÏÜå Î≤ÑÌäº */}
              {hasChildren && (
                <div className={`
                  ml-auto p-2 rounded-lg
                  ${levelStyle.bg} bg-opacity-50
                  group-hover:bg-opacity-100
                  transition-all duration-300
                `}>
                  {isExpanded ? (
                    <ChevronDown className={`w-5 h-5 ${levelStyle.text}`} />
                  ) : (
                    <ChevronRight className={`w-5 h-5 ${levelStyle.text}`} />
                  )}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* ÏûêÏãù ÎÖ∏ÎìúÎì§ Î†åÎçîÎßÅ - ÌôïÏû•/Ï∂ïÏÜå Ïï†ÎãàÎ©îÏù¥ÏÖò */}
        {hasChildren && isExpanded && (
          <div className="relative animate-fadeIn">
            {/* ÏûêÏãùÏúºÎ°ú Ïó∞Í≤∞ÎêòÎäî ÏàòÏßÅÏÑ† - Í∑∏ÎùºÎç∞Ïù¥ÏÖò */}
            {node.children.length > 1 && (
              <div
                className="absolute"
                style={{
                  left: '-24px',
                  top: '0',
                  width: '2px',
                  height: `${(node.children.length - 1) * 100}px`,
                  background: 'linear-gradient(180deg, rgba(156, 163, 175, 0.5) 0%, rgba(156, 163, 175, 0.1) 100%)'
                }}
              />
            )}

            {/* ÏûêÏãù ÎÖ∏ÎìúÎì§ */}
            {node.children.map((childNode, index) => (
              <HierarchyNode
                key={childNode.user?.id || `child-${index}`}
                node={childNode}
                level={level + 1}
                isLast={index === node.children.length - 1}
                parentRef={nodeRef}
              />
            ))}
          </div>
        )}
      </div>
    );
  };


  return (
    <div className="min-h-screen bg-background dark:bg-gray-900">
      <div className="container mx-auto p-6">
        {/* ÌéòÏù¥ÏßÄ Ìó§Îçî */}
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-foreground dark:text-white mb-2">ÌïòÏúÑ Î∏åÎ°úÏª§ Ï†ïÏÇ∞</h1>
          <p className="text-muted-foreground dark:text-gray-400">Î∏åÎ°úÏª§ ÎÑ§Ìä∏ÏõåÌÅ¨ Î∞è Ï†ïÏÇ∞ ÌòÑÌô©ÏùÑ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî</p>
        </div>

        {/* ÎÖÑ/Ïõî ÏÑ†ÌÉù Î∞ïÏä§ */}
        <div className="mb-6 flex items-center space-x-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
          <Calendar className="text-gray-500 dark:text-gray-400" size={20} />
          <div className="flex items-center space-x-2">
            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Ï°∞Ìöå Í∏∞Í∞Ñ:</label>
            <select 
              value={selectedYear} 
              onChange={(e) => setSelectedYear(e.target.value)}
              className="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {years.map(year => (
                <option key={year} value={year}>{year}ÎÖÑ</option>
              ))}
            </select>
            <select 
              value={selectedMonth} 
              onChange={(e) => setSelectedMonth(e.target.value)}
              className="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {months.map(month => (
                <option key={month.value} value={month.value}>{month.label}</option>
              ))}
            </select>
          </div>
        </div>

        {/* ÏÉÅÎã® Ïç®Î®∏Î¶¨ */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-blue-100 text-sm">Î∞õÏùÑ Ï†ïÏÇ∞Í∏à</p>
                <p className="text-2xl font-bold">{summary.incomingSettlement}</p>
              </div>
              <TrendingUp className="text-blue-200" size={32} />
            </div>
          </div>
          
          <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-purple-100 text-sm">ÏßÄÍ∏âÌï† Ï†ïÏÇ∞Í∏à</p>
                <p className="text-2xl font-bold">{summary.outgoingSettlement}</p>
              </div>
              <DollarSign className="text-purple-200" size={32} />
            </div>
          </div>
          
          <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-green-100 text-sm">Ïàú ÏàòÏùµ</p>
                <p className="text-2xl font-bold">{summary.netProfit}</p>
              </div>
              <Users className="text-green-200" size={32} />
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Î∏åÎ°úÏª§ ÎÑ§Ìä∏ÏõåÌÅ¨ Ìä∏Î¶¨ */}
          <div className="lg:col-span-2">
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-6">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-xl font-semibold text-foreground dark:text-white">Î∏åÎ°úÏª§ ÎÑ§Ìä∏ÏõåÌÅ¨</h2>
                <button
                  onClick={fetchHierarchyTree}
                  disabled={loading}
                  className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors disabled:opacity-50"
                  title="ÏÉàÎ°úÍ≥†Ïπ®"
                >
                  <RefreshCw className={`h-5 w-5 text-gray-600 dark:text-gray-400 ${loading ? 'animate-spin' : ''}`} />
                </button>
              </div>
              
              {loading ? (
                <div className="flex items-center justify-center h-64">
                  <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                </div>
              ) : error ? (
                <div className="flex flex-col items-center justify-center h-64 text-center">
                  <AlertCircle className="h-12 w-12 text-red-500 mb-4" />
                  <p className="text-red-500 mb-4">{error}</p>
                  <button
                    onClick={fetchHierarchyTree}
                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center"
                  >
                    <RefreshCw className="mr-2" size={16} />
                    Îã§Ïãú ÏãúÎèÑ
                  </button>
                </div>
              ) : hierarchyData ? (
                <div className="relative overflow-x-auto p-8">
                  {/* Î£®Ìä∏ ÎÖ∏Îìú (ÎÇò) - Î™®Îçò ÌîÑÎ¶¨ÎØ∏ÏóÑ ÎîîÏûêÏù∏ */}
                  <div className="mb-8">
                    <div className="relative overflow-hidden max-w-2xl">
                      {/* Í∏ÄÎûòÏä§Î™®ÌîºÏ¶ò Ïπ¥Îìú */}
                      <div className="relative backdrop-blur-xl bg-gradient-to-r from-purple-900/40 via-indigo-900/40 to-blue-900/40 rounded-3xl border border-purple-500/30 p-6 shadow-2xl">
                        {/* Î∞∞Í≤Ω Í∑∏ÎùºÎç∞Ïù¥ÏÖò Ïò§Î≤ÑÎ†àÏù¥ */}
                        <div className="absolute inset-0 bg-gradient-to-br from-purple-600/10 via-transparent to-blue-600/10 rounded-3xl" />

                        <div className="relative flex items-center gap-5">
                          {/* ÌîÑÎ°úÌïÑ ÏïÑÎ∞îÌÉÄ */}
                          <div className="relative">
                            <div className="w-16 h-16 bg-gradient-to-br from-purple-500 via-indigo-500 to-blue-500 rounded-2xl shadow-2xl flex items-center justify-center">
                              <span className="text-white font-bold text-xl">
                                {hierarchyData.user?.name?.charAt(0) || 'ÎÇò'}
                              </span>
                            </div>
                            {/* ÏßÅÏ†ë Ï∂îÏ≤ú Î∞∞ÏßÄ */}
                            {hierarchyData.user?.direct_referral_count > 0 && (
                              <div className="absolute -top-2 -right-2 min-w-[28px] h-7 px-2 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center shadow-xl">
                                <span className="text-white font-bold text-sm">
                                  {hierarchyData.user.direct_referral_count}
                                </span>
                              </div>
                            )}
                            {/* ÏôïÍ¥Ä ÏïÑÏù¥ÏΩò - ROOT ÌëúÏãú */}
                            <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2">
                              <div className="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-full flex items-center justify-center shadow-lg">
                                <span className="text-xs">üëë</span>
                              </div>
                            </div>
                          </div>

                          {/* Ï†ïÎ≥¥ ÏÑπÏÖò */}
                          <div className="flex-1">
                            {/* Ïù¥Î¶ÑÍ≥º Ïó≠Ìï† */}
                            <div className="flex items-center gap-3 mb-3">
                              <h2 className="text-2xl font-bold bg-gradient-to-r from-purple-200 to-blue-200 bg-clip-text text-transparent">
                                {hierarchyData.user?.name || 'ÎÇò'}
                              </h2>
                              <span className="px-3 py-1 bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-sm font-bold rounded-full shadow-lg">
                                Ï¥ù Î∏åÎ°úÏª§
                              </span>
                              <span className="px-3 py-1 bg-white/10 backdrop-blur border border-white/20 text-white text-sm font-medium rounded-full">
                                ROOT
                              </span>
                            </div>

                            {/* ÌÜµÍ≥Ñ Ï†ïÎ≥¥ */}
                            <div className="flex flex-wrap items-center gap-5">
                              <div className="flex items-center gap-2">
                                <div className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse" />
                                <span className="text-yellow-300 font-medium">
                                  ÏöîÏú®: 0.02%
                                </span>
                              </div>
                              <div className="flex items-center gap-2">
                                <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse" />
                                <span className="text-green-300 font-medium">
                                  Ï¥ù ÏàòÏùµ: ‚Ç©{(hierarchyData.stats?.total_revenue || 15080000).toLocaleString()}
                                </span>
                              </div>
                              <div className="flex items-center gap-2">
                                <div className="w-2 h-2 bg-blue-400 rounded-full animate-pulse" />
                                <span className="text-blue-300 font-medium">
                                  Ï¥ù ÌïòÏúÑ: {hierarchyData.stats?.total_referrals || 0}Î™Ö
                                </span>
                              </div>
                            </div>

                            {/* Ïù¥Î©îÏùº */}
                            <div className="mt-3 text-sm text-gray-400">
                              {hierarchyData.user?.email}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* ÌïòÏúÑ Í≥ÑÏ∏µ Ìä∏Î¶¨ */}
                  {hierarchyData.children && hierarchyData.children.length > 0 && (
                    <div className="relative">
                      {/* Î£®Ìä∏ÏóêÏÑú Ï≤´ ÏûêÏãùÏúºÎ°ú Í∞ÄÎäî ÏàòÏßÅÏÑ† */}
                      <div className="absolute w-0.5 bg-gray-400 dark:bg-gray-600"
                           style={{
                             left: '24px',
                             top: '-30px',
                             height: '50px'
                           }} />

                      {/* ÏûêÏãùÏù¥ Ïó¨Îü¨ Î™ÖÏùº Îïå ÏàòÏßÅ Ïó∞Í≤∞ÏÑ† */}
                      {hierarchyData.children.length > 1 && (
                        <div className="absolute w-0.5 bg-gray-400 dark:bg-gray-600"
                             style={{
                               left: '24px',
                               top: '44px',
                               height: `${(hierarchyData.children.length - 1) * 80}px`
                             }} />
                      )}

                      {/* ÏûêÏãù ÎÖ∏ÎìúÎì§ */}
                      <div className="ml-12">
                        {hierarchyData.children.map((childNode, index) => (
                          <HierarchyNode
                            key={childNode.user?.id || `child-${index}`}
                            node={childNode}
                            level={1}
                            isLast={index === hierarchyData.children.length - 1}
                          />
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <div className="text-center text-muted-foreground py-8">
                  Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
              )}
            </div>
          </div>

          {/* Í∞êÏÇ¨ Î°úÍ∑∏ */}
          <div className="lg:col-span-1">
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-6">
              <h2 className="text-xl font-semibold mb-6 text-foreground dark:text-white flex items-center">
                <History className="mr-2" size={20} />
                Í∞êÏÇ¨ Î°úÍ∑∏
              </h2>
              
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {auditLogs.map((log) => (
                  <div key={log.id} className="border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-gray-50 dark:bg-gray-700/50">
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-medium text-sm text-foreground dark:text-white">{log.broker}</span>
                      <span className="text-xs text-muted-foreground dark:text-gray-400">{log.date}</span>
                    </div>
                    <div className="text-xs text-muted-foreground dark:text-gray-400">
                      <span className="text-red-600 dark:text-red-400">{log.oldRate}</span> ‚Üí <span className="text-green-600 dark:text-green-400">{log.newRate}</span>
                    </div>
                    <div className="text-xs text-muted-foreground dark:text-gray-400 mt-1">
                      Î≥ÄÍ≤ΩÏûê: {log.changedBy}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* Ï†ïÏÇ∞ ÏöîÏú® Î≥ÄÍ≤Ω Î™®Îã¨ */}
        {showRateModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 shadow-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-foreground dark:text-white">Ï†ïÏÇ∞ ÏöîÏú® Î≥ÄÍ≤Ω</h3>
                <button 
                  onClick={() => setShowRateModal(false)}
                  className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                >
                  <X size={20} />
                </button>
              </div>
              
              {selectedBroker && (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      Î∏åÎ°úÏª§: {selectedBroker.name}
                    </label>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      ÌòÑÏû¨ ÏöîÏú®: {selectedBroker.rate}
                    </label>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      ÏÉà ÏöîÏú®
                    </label>
                    <input
                      type="text"
                      value={newRate}
                      onChange={(e) => setNewRate(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                      placeholder="Ïòà: 0.02%"
                    />
                  </div>
                  
                  <div className="flex space-x-3">
                    <button
                      onClick={handleRateUpdate}
                      className="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center"
                    >
                      <Save size={16} className="mr-2" />
                      Ï†ÄÏû•
                    </button>
                    <button
                      onClick={() => setShowRateModal(false)}
                      className="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors"
                    >
                      Ï∑®ÏÜå
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default BrokerNetworkPage; 